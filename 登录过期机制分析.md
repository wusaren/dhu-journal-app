# 登录过期机制分析

## 问题描述
重启服务后，原先默认创建的用户显示登录过期。

## 登录过期判定机制

### 1. Flask-Security 配置分析
在 `app.py` 中，有以下相关配置：

```python
# Flask-Security 配置
app.config['SECRET_KEY'] = os.environ.get("SECRET_KEY", secrets.token_urlsafe(32))
app.config['SECURITY_PASSWORD_SALT'] = os.environ.get("SECURITY_PASSWORD_SALT", secrets.token_urlsafe(32))
app.config['SECURITY_TOKEN_AUTHENTICATION_HEADER'] = 'Authorization'
app.config['SECURITY_TOKEN_MAX_AGE'] = 3600  # 1小时
```

### 2. 登录过期判定的原因

#### 2.1 会话存储机制
Flask-Security 使用以下机制来管理用户会话：

1. **服务器重启导致会话丢失**
   - Flask 默认使用内存存储会话
   - 服务器重启后，所有内存中的会话数据都会丢失
   - 即使数据库中的用户数据仍然存在，会话令牌也会失效

2. **SECRET_KEY 变化**
   - 每次重启服务时，如果没有设置固定的 SECRET_KEY，会生成新的随机密钥
   - 新的 SECRET_KEY 无法验证之前生成的会话令牌
   - 导致所有现有会话都变为无效

3. **令牌过期时间**
   - `SECURITY_TOKEN_MAX_AGE = 3600` 设置令牌有效期为1小时
   - 但服务器重启会立即使所有令牌失效

### 3. 解决方案

#### 3.1 设置固定的 SECRET_KEY
在 `.env` 文件中设置固定的密钥：

```env
SECRET_KEY=your-fixed-secret-key-here
SECURITY_PASSWORD_SALT=your-fixed-password-salt-here
```

#### 3.2 使用持久化会话存储
配置 Flask 使用数据库或文件系统存储会话：

```python
from flask_session import Session

# 配置会话存储
app.config['SESSION_TYPE'] = 'filesystem'
Session(app)
```

#### 3.3 延长令牌有效期（开发环境）
对于开发环境，可以延长令牌有效期：

```python
app.config['SECURITY_TOKEN_MAX_AGE'] = 86400  # 24小时
```

### 4. 当前系统的实际表现

**登录流程**：
1. 用户登录时，Flask-Security 生成会话令牌
2. 令牌存储在服务器内存中
3. 前端在后续请求中通过 Authorization 头传递令牌
4. 服务器重启后，内存中的令牌数据丢失
5. 即使使用相同的用户凭据，之前的会话令牌已失效

**这就是为什么重启服务后需要重新登录的原因**。

### 5. 生产环境建议

对于生产环境，建议：

1. **使用固定的 SECRET_KEY**
2. **使用数据库存储会话**
3. **配置适当的令牌刷新机制**
4. **实现记住登录功能**

### 6. 开发环境临时解决方案

对于开发测试，最简单的解决方案是：

1. 设置固定的 SECRET_KEY 和 SECURITY_PASSWORD_SALT
2. 重启服务后重新登录即可

这种机制实际上是安全性的体现，防止会话被恶意重用。
